<!-- P치gina HTML para analizar logs Apache y FTP -->
 
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Analizador de Logs</title>
    <!-- Estilos b치sicos para la tabla -->
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        th, td {
            padding: 4px 8px;
        }
        .alert { color: red; }
        .success { color: green; }
    </style>
    <!-- Archivo de estilos externo -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Analizador de Logs - FTP & Apache</h1>

    <!-- Subida de archivo de log -->
    <input type="file" id="fileInput">
    <select id="logType">
        <option value="apache">Apache</option>
        <option value="ftp">FTP</option>
    </select>
    <button onclick="uploadFile()">Subir Log</button>
    <button onclick="reloadLogs()">Recargar Log</button>

    <!-- Buscador y acciones extra -->
    <br><br>
    <input type="text" id="search" placeholder="Buscar..." oninput="filterLogs()">
    <button onclick="copySelected()">Copiar Seleccionados</button>
    <button onclick="showErrorsOnly()">Mostrar Errores</button>

    <div id="alerts"></div>
    <br>

    <!-- Tabla para mostrar los logs -->
    <table id="logTable">
        <thead>
            <tr>
                <th></th>
                <th>Fecha</th>
                <th>IP</th>
                <th>Evento</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Bot칩n para mostrar gr치ficas -->
    <div style="position: fixed; bottom: 20px; right: 20px;">
        <button onclick="toggleChart()">游늵 Ver Gr치ficas</button>
    </div>

    <!-- Contenedor de la gr치fica -->
    <div id="chartContainer" style="display:none; max-width: 400px; margin: 20px auto;">
        <canvas id="eventChart"></canvas>
    </div>

    <!-- Librer칤a Chart.js para gr치ficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let logs = []; // Aqu칤 se guardan los logs cargados
        let chartVisible = false;
        let eventChart;

        // Funci칩n para subir un archivo al backend
        function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            const type = document.getElementById('logType').value;
            if (!file) return alert('Selecciona un archivo');

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                fetch('http://localhost:3001/api/logs/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, type })
                }).then(() => loadLogs(type)); // Recarga los logs despu칠s de subir
            };
            reader.readAsText(file);
        }

        // Funci칩n para obtener logs del servidor y mostrarlos
        function loadLogs(type = document.getElementById('logType').value) {
            fetch(`http://localhost:3001/api/logs/${type}`)
                .then(res => res.json())
                .then(data => {
                    // Formatea los datos para mostrarlos en la tabla
                    logs = data.logs.map(entry => ({
                        fecha: entry.fecha,
                        ip: entry.ip,
                        evento: entry.metodo ? `${entry.metodo} ${entry.recurso} (${entry.codigo})` : `${entry.accion} ${entry.archivo || ''} [${entry.estado}]`
                    }));
                    renderTable(logs);
                });
        }

        // Recarga logs desde un archivo local (en el servidor)
        function reloadLogs() {
            fetch('http://localhost:3001/api/logs/reload')
                .then(() => loadLogs());
        }

        // Muestra los logs en la tabla HTML
        function renderTable(data) {
            const tbody = document.querySelector('#logTable tbody');
            tbody.innerHTML = '';
            data.forEach(entry => {
                const row = `<tr>
                    <td><input type="checkbox"></td>
                    <td>${entry.fecha}</td>
                    <td>${entry.ip}</td>
                    <td>${entry.evento}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // Filtra los logs seg칰n lo que el usuario escribe en el buscador
        function filterLogs() {
            const query = document.getElementById('search').value.toLowerCase();
            const filtered = logs.filter(entry =>
                entry.fecha.toLowerCase().includes(query) ||
                entry.ip.toLowerCase().includes(query) ||
                entry.evento.toLowerCase().includes(query)
            );
            renderTable(filtered);
        }

        // Copia los logs seleccionados al portapapeles
        function copySelected() {
            const selected = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.closest('tr').innerText)
                .join('\n');
            navigator.clipboard.writeText(selected);
        }

        // Muestra solo los eventos que contienen errores o fallos
        function showErrorsOnly() {
            const filtered = logs.filter(log =>
                log.evento.toLowerCase().includes('error') ||
                log.evento.toLowerCase().includes('fail')
            );
            renderTable(filtered);
        }

        // Alterna la visibilidad del gr치fico de eventos
        function toggleChart() {
            const chartDiv = document.getElementById('chartContainer');
            chartVisible = !chartVisible;
            chartDiv.style.display = chartVisible ? 'block' : 'none';
            if (chartVisible) renderChart();
        }

        // Dibuja el gr치fico con los tipos de eventos
        function renderChart() {
            const eventCounts = {};

            logs.forEach(log => {
                const tipo = getTipoEvento(log.evento);
                eventCounts[tipo] = (eventCounts[tipo] || 0) + 1;
            });

            const labels = Object.keys(eventCounts);
            const data = Object.values(eventCounts);

            const ctx = document.getElementById('eventChart').getContext('2d');

            if (eventChart) eventChart.destroy(); // Elimina gr치fico anterior si existe
            eventChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eventos',
                        data: data,
                        backgroundColor: [
                            '#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#9966ff', '#ff9f40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Clasifica el tipo de evento para usarlo en el gr치fico
        function getTipoEvento(evento) {
            evento = evento.toLowerCase();
            if (evento.includes('failed') || evento.includes('fail')) return 'Fallidos';
            if (evento.includes('login')) return 'Login';
            if (evento.includes('upload')) return 'Upload';
            if (evento.includes('download')) return 'Download';
            if (evento.includes('error')) return 'Error';
            return 'Otros';
        }
    </script>
</body>
</html>
